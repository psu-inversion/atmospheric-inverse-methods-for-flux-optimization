
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>atmos_flux_inversion.variational module &#8212; Inversions 1.0.0 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"extensions": ["tex2jax.js"], "jax": ["input/TeX", "output/HTML-CSS"], "TeX": {"extensions": ["AMSmath.js"]}})</script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="atmos_flux_inversion.psas module" href="atmos_flux_inversion.psas.html" />
    <link rel="prev" title="atmos_flux_inversion.optimal_interpolation module" href="atmos_flux_inversion.optimal_interpolation.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="atmos_flux_inversion.psas.html" title="atmos_flux_inversion.psas module"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="atmos_flux_inversion.optimal_interpolation.html" title="atmos_flux_inversion.optimal_interpolation module"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Inversions 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="atmos_flux_inversion.html" accesskey="U">atmos_flux_inversion package</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">atmos_flux_inversion.variational module</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="module-atmos_flux_inversion.variational">
<span id="atmos-flux-inversion-variational-module"></span><h1>atmos_flux_inversion.variational module<a class="headerlink" href="#module-atmos_flux_inversion.variational" title="Permalink to this headline">¶</a></h1>
<p>Functions implementing 3D-Var.</p>
<dl class="simple">
<dt>Signatures follow the functions in</dt><dd><p><a class="reference internal" href="atmos_flux_inversion.optimal_interpolation.html#module-atmos_flux_inversion.optimal_interpolation" title="atmos_flux_inversion.optimal_interpolation"><code class="xref py py-mod docutils literal notranslate"><span class="pre">atmos_flux_inversion.optimal_interpolation</span></code></a></p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Forces in-memory computations.  BFGS method requires this, and there
are odd shape-mismatch errors if I just change to dask arrays.
Conjugate gradient solvers may work better for dask arrays if we drop
the covariance matrix from the return values.</p>
</div>
<dl class="py function">
<dt id="atmos_flux_inversion.variational.incr_chol">
<code class="sig-prename descclassname">atmos_flux_inversion.variational.</code><code class="sig-name descname">incr_chol</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">background</span></em>, <em class="sig-param"><span class="n">background_covariance</span></em>, <em class="sig-param"><span class="n">observations</span></em>, <em class="sig-param"><span class="n">observation_covariance</span></em>, <em class="sig-param"><span class="n">observation_operator</span></em>, <em class="sig-param"><span class="n">reduced_background_covariance</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">reduced_observation_operator</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/atmos_flux_inversion/variational.html#incr_chol"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#atmos_flux_inversion.variational.incr_chol" title="Permalink to this definition">¶</a></dt>
<dd><p>Feed everything to scipy’s minimizer.</p>
<p>Use the change from the background to try to avoid precision loss.
Also use Cholesky factorization of the covariances to speed
solution of matrix equations.</p>
<p>Assumes everything follows a multivariate normal distribution
with the specified covariance matrices.  Under this assumption
<cite>analysis_covariance</cite> is exact, and <cite>analysis</cite> is the Maximum
Likelihood Estimator and the Best Linear Unbiased Estimator
for the underlying state in the frequentist framework, and
specify the posterior distribution for the state in the
Bayesian framework.  If these are not satisfied, these still
form the Generalized Least Squares estimates for the state and
an estimated uncertainty.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>background</strong> (<em>array_like</em><em>[</em><em>N</em><em>]</em>) – The background state estimate.</p></li>
<li><p><strong>background_covariance</strong> (<em>array_like</em><em>[</em><em>N</em><em>, </em><em>N</em><em>]</em>) – Covariance of background state estimate across
realizations/ensemble members.  “Ensemble” is here
interpreted in the sense used in statistical mechanics or
frequentist statistics, and may not be derived from a
sample as in meteorological ensemble Kalman filters</p></li>
<li><p><strong>observations</strong> (<em>array_like</em><em>[</em><em>M</em><em>]</em>) – The observations constraining the background estimate.</p></li>
<li><p><strong>observation_covariance</strong> (<em>array_like</em><em>[</em><em>M</em><em>, </em><em>M</em><em>]</em>) – Covariance of observations across realizations/ensemble
members.  “Ensemble” again has the statistical meaning.</p></li>
<li><p><strong>observation_operator</strong> (<em>array_like</em><em>[</em><em>M</em><em>, </em><em>N</em><em>]</em>) – The relationship between the state and the observations.</p></li>
<li><p><strong>reduced_background_covariance</strong> (<em>array_like</em><em>[</em><em>Nred</em><em>, </em><em>Nred</em><em>]</em><em>, </em><em>optional</em>) – The covariance for a smaller state space, usually obtained by
reducing resolution in space and time.  Note that
<cite>reduced_observation_operator</cite> must also be provided</p></li>
<li><p><strong>reduced_observation_operator</strong> (<em>array_like</em><em>[</em><em>M</em><em>, </em><em>Nred</em><em>]</em><em>, </em><em>optional</em>) – The relationship between the reduced state space and the
observations.  Note that <cite>reduced_background_covariance</cite>
must also be provided.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><ul class="simple">
<li><p><strong>analysis</strong> (<em>array_like[N]</em>) – Analysis state estimate</p></li>
<li><p><strong>analysis_covariance</strong> (<em>array_like[Nred, Nred] or array_like[N, N]</em>) – Estimated uncertainty of analysis across
realizations/ensemble members.  Calculated using
reduced_background_covariance and
reduced_observation_operator if possible</p></li>
</ul>
</p>
</dd>
<dt class="field-odd">Raises</dt>
<dd class="field-odd"><p><a class="reference internal" href="atmos_flux_inversion.html#atmos_flux_inversion.ConvergenceError" title="atmos_flux_inversion.ConvergenceError"><strong>ConvergenceError</strong></a> – If iterative solver does not converge</p>
</dd>
</dl>
<p class="rubric">Notes</p>
<p>minimizes</p>
<div class="math notranslate nohighlight">
\[(dx)^T P_B^{-1} (dx) + (y - h(x_0) - H dx)^T R^{-1} (y - h(x_0) - H dx)\]</div>
<p>which has gradient</p>
<div class="math notranslate nohighlight">
\[P_B^{-1} (dx) - H^T R^{-1} (y - h(x) - H dx)\]</div>
<p>where <span class="math notranslate nohighlight">\(x = x_0 + dx\)</span></p>
</dd></dl>

<dl class="py function">
<dt id="atmos_flux_inversion.variational.incremental">
<code class="sig-prename descclassname">atmos_flux_inversion.variational.</code><code class="sig-name descname">incremental</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">background</span></em>, <em class="sig-param"><span class="n">background_covariance</span></em>, <em class="sig-param"><span class="n">observations</span></em>, <em class="sig-param"><span class="n">observation_covariance</span></em>, <em class="sig-param"><span class="n">observation_operator</span></em>, <em class="sig-param"><span class="n">reduced_background_covariance</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">reduced_observation_operator</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/atmos_flux_inversion/variational.html#incremental"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#atmos_flux_inversion.variational.incremental" title="Permalink to this definition">¶</a></dt>
<dd><p>Feed everything to scipy’s minimizer.</p>
<p>Use the change from the background to try to avoid precision loss.</p>
<p>Assumes everything follows a multivariate normal distribution
with the specified covariance matrices.  Under this assumption
<cite>analysis_covariance</cite> is exact, and <cite>analysis</cite> is the Maximum
Likelihood Estimator and the Best Linear Unbiased Estimator
for the underlying state in the frequentist framework, and
specify the posterior distribution for the state in the
Bayesian framework.  If these are not satisfied, these still
form the Generalized Least Squares estimates for the state and
an estimated uncertainty.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>background</strong> (<em>array_like</em><em>[</em><em>N</em><em>]</em>) – The background state estimate.</p></li>
<li><p><strong>background_covariance</strong> (<em>array_like</em><em>[</em><em>N</em><em>, </em><em>N</em><em>]</em>) – Covariance of background state estimate across
realizations/ensemble members.  “Ensemble” is here
interpreted in the sense used in statistical mechanics or
frequentist statistics, and may not be derived from a
sample as in meteorological ensemble Kalman filters</p></li>
<li><p><strong>observations</strong> (<em>array_like</em><em>[</em><em>M</em><em>]</em>) – The observations constraining the background estimate.</p></li>
<li><p><strong>observation_covariance</strong> (<em>array_like</em><em>[</em><em>M</em><em>, </em><em>M</em><em>]</em>) – Covariance of observations across realizations/ensemble
members.  “Ensemble” again has the statistical meaning.</p></li>
<li><p><strong>observation_operator</strong> (<em>array_like</em><em>[</em><em>M</em><em>, </em><em>N</em><em>]</em>) – The relationship between the state and the observations.</p></li>
<li><p><strong>reduced_background_covariance</strong> (<em>array_like</em><em>[</em><em>Nred</em><em>, </em><em>Nred</em><em>]</em><em>, </em><em>optional</em>) – The covariance for a smaller state space, usually obtained by
reducing resolution in space and time.  Note that
<cite>reduced_observation_operator</cite> must also be provided</p></li>
<li><p><strong>reduced_observation_operator</strong> (<em>array_like</em><em>[</em><em>M</em><em>, </em><em>Nred</em><em>]</em><em>, </em><em>optional</em>) – The relationship between the reduced state space and the
observations.  Note that <cite>reduced_background_covariance</cite>
must also be provided.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><ul class="simple">
<li><p><strong>analysis</strong> (<em>array_like[N]</em>) – Analysis state estimate</p></li>
<li><p><strong>analysis_covariance</strong> (<em>array_like[Nred, Nred] or array_like[N, N]</em>) – Estimated uncertainty of analysis across
realizations/ensemble members.  Calculated using
reduced_background_covariance and
reduced_observation_operator if possible</p></li>
</ul>
</p>
</dd>
<dt class="field-odd">Raises</dt>
<dd class="field-odd"><p><a class="reference internal" href="atmos_flux_inversion.html#atmos_flux_inversion.ConvergenceError" title="atmos_flux_inversion.ConvergenceError"><strong>ConvergenceError</strong></a> – If iterative solver does not converge</p>
</dd>
</dl>
<p class="rubric">Notes</p>
<p>minimizes</p>
<div class="math notranslate nohighlight">
\[(dx)^T P_B^{-1} (dx) + (y - h(x_0) - H dx)^T R^{-1} (y - h(x_0) - H dx)\]</div>
<p>which has gradient</p>
<div class="math notranslate nohighlight">
\[P_B^{-1} (dx) - H^T R^{-1} (y - h(x) - H dx)\]</div>
<p>where <span class="math notranslate nohighlight">\(x = x_0 + dx\)</span></p>
</dd></dl>

<dl class="py function">
<dt id="atmos_flux_inversion.variational.simple">
<code class="sig-prename descclassname">atmos_flux_inversion.variational.</code><code class="sig-name descname">simple</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">background</span></em>, <em class="sig-param"><span class="n">background_covariance</span></em>, <em class="sig-param"><span class="n">observations</span></em>, <em class="sig-param"><span class="n">observation_covariance</span></em>, <em class="sig-param"><span class="n">observation_operator</span></em>, <em class="sig-param"><span class="n">reduced_background_covariance</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">reduced_observation_operator</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/atmos_flux_inversion/variational.html#simple"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#atmos_flux_inversion.variational.simple" title="Permalink to this definition">¶</a></dt>
<dd><p>Feed everything to scipy’s minimizer.</p>
<p>Assumes everything follows a multivariate normal distribution
with the specified covariance matrices.  Under this assumption
<cite>analysis_covariance</cite> is exact, and <cite>analysis</cite> is the Maximum
Likelihood Estimator and the Best Linear Unbiased Estimator
for the underlying state in the frequentist framework, and
specify the posterior distribution for the state in the
Bayesian framework.  If these are not satisfied, these still
form the Generalized Least Squares estimates for the state and
an estimated uncertainty.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>background</strong> (<em>array_like</em><em>[</em><em>N</em><em>]</em>) – The background state estimate.</p></li>
<li><p><strong>background_covariance</strong> (<em>array_like</em><em>[</em><em>N</em><em>, </em><em>N</em><em>]</em>) – Covariance of background state estimate across
realizations/ensemble members.  “Ensemble” is here
interpreted in the sense used in statistical mechanics or
frequentist statistics, and may not be derived from a
sample as in meteorological ensemble Kalman filters</p></li>
<li><p><strong>observations</strong> (<em>array_like</em><em>[</em><em>M</em><em>]</em>) – The observations constraining the background estimate.</p></li>
<li><p><strong>observation_covariance</strong> (<em>array_like</em><em>[</em><em>M</em><em>, </em><em>M</em><em>]</em>) – Covariance of observations across realizations/ensemble
members.  “Ensemble” again has the statistical meaning.</p></li>
<li><p><strong>observation_operator</strong> (<em>array_like</em><em>[</em><em>M</em><em>, </em><em>N</em><em>]</em>) – The relationship between the state and the observations.</p></li>
<li><p><strong>reduced_background_covariance</strong> (<em>array_like</em><em>[</em><em>Nred</em><em>, </em><em>Nred</em><em>]</em><em>, </em><em>optional</em>) – The covariance for a smaller state space, usually obtained by
reducing resolution in space and time.  Note that
<cite>reduced_observation_operator</cite> must also be provided</p></li>
<li><p><strong>reduced_observation_operator</strong> (<em>array_like</em><em>[</em><em>M</em><em>, </em><em>Nred</em><em>]</em><em>, </em><em>optional</em>) – The relationship between the reduced state space and the
observations.  Note that <cite>reduced_background_covariance</cite>
must also be provided.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><ul class="simple">
<li><p><strong>analysis</strong> (<em>array_like[N]</em>) – Analysis state estimate</p></li>
<li><p><strong>analysis_covariance</strong> (<em>array_like[Nred, Nred] or array_like[N, N]</em>) – Estimated uncertainty of analysis across
realizations/ensemble members.  Calculated using
reduced_background_covariance and
reduced_observation_operator if possible</p></li>
</ul>
</p>
</dd>
<dt class="field-odd">Raises</dt>
<dd class="field-odd"><p><a class="reference internal" href="atmos_flux_inversion.html#atmos_flux_inversion.ConvergenceError" title="atmos_flux_inversion.ConvergenceError"><strong>ConvergenceError</strong></a> – If iterative solver does not converge</p>
</dd>
</dl>
<p class="rubric">Notes</p>
<p>minimizes</p>
<div class="math notranslate nohighlight">
\[(x - x_0)^T P_B^{-1} (x - x_0) + (y - h(x))^T R^{-1} (y - h(x))\]</div>
<p>which has gradient</p>
<div class="math notranslate nohighlight">
\[P_B^{-1} (x - x_0) + H^T R^{-1} (y - h(x))\]</div>
</dd></dl>

</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="atmos_flux_inversion.optimal_interpolation.html"
                        title="previous chapter">atmos_flux_inversion.optimal_interpolation module</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="atmos_flux_inversion.psas.html"
                        title="next chapter">atmos_flux_inversion.psas module</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/atmos_flux_inversion.variational.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="atmos_flux_inversion.psas.html" title="atmos_flux_inversion.psas module"
             >next</a> |</li>
        <li class="right" >
          <a href="atmos_flux_inversion.optimal_interpolation.html" title="atmos_flux_inversion.optimal_interpolation module"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Inversions 1.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="atmos_flux_inversion.html" >atmos_flux_inversion package</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">atmos_flux_inversion.variational module</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018–2020, The Pennsylvania State University.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.1.2.
    </div>
  </body>
</html>